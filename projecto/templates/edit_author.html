{% extends 'basic_layout.html' %}

{% block custom_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='js/MagicSuggest/magicsuggest-min.css') }}">
{% endblock custom_css %}

{% block body %}

<div>
  <h2 class="text-center"> Edit and update {{author.name|upper}} {% if author.surname %} {{author.surname}} {% endif %}'s information </h2>
  <form method="POST" action="{{url_for('edit_author', author_id=author.id)}}">
     {{form.csrf_token}}
        <div class="form-group {% if form.name.errors %}has-error{% endif %}">
          {{form.name.label(class_="control-label")}}
          {{form.name(class_="form-control", placeholder="Enter name...")}}
          {% if form.name.errors %}
          <span class="help-block">{{ ' '.join(form.name.errors) }}</span>
          {% endif %}
        </div>
        <div class="form-group {% if form.surname.errors %}has-error{% endif %}">
          {{form.surname.label(class_="control-label")}}
          {{form.surname(class_="form-control", placeholder="Enter surname...")}}
          {% if form.surname.errors %}
          <span class="help-block">{{ ' '.join(form.surname.errors) }}</span>
          {% endif %}
        </div>
        <div class="form-group {% if form.books.errors %} has-error {% endif %}">
          {{form.books.label(class_="control-label")}}
          {{form.books(class_="form-control hidden")}}
          {% if form.books.errors %}
          <span class="help-block" id="books-errors">{{ ' '.join(form.books.errors) }}</span>
          {% endif %}
          <div id="books-tagsinput"></div>
        </div>
        <button id="load-more-suggestions-button" class="btn" type="button">Load more suggestions for query</button> <span>Your current query: <span id='current-query'></span></span>
        <div class="form-group {% if form.description.errors %}has-error{% endif %}">
          {{form.description.label}}
          {{form.description(class_="form-control", placeholder="Provide a few relevant details...")}}
          {% if form.description.errors %}
          <span class="help-block">{{ ' '.join(form.description.errors) }}</span>
          {% endif %}
        </div>
        <div>
          <input type="Submit" class="btn btn-primary" value="Save changes"> <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
        </div>
  </form>
</div>

{% endblock body %}


{% block custom_links_js %}
    <script src="{{ url_for('static', filename='js/MagicSuggest/magicsuggest.js') }}" type="text/javascript" charset="utf-8"></script>
{% endblock %}

{% block custom_js %}
<script type="text/javascript">

  $(document).ready(function() {

//variables for tracking suggestions
  var chunk = 1;
  var lastQuery = null;
  var finished = false;
  var additionalSuggestions = [];

var suggestionsField = $('#books-tagsinput').magicSuggest({
  data: function(q) {
          if (((q.trim()).length == 0 || q == lastQuery) && additionalSuggestions.length > 0) {
            return additionalSuggestions;
          }
          chunk = 1
          additionalSuggestions = []
          return "{{url_for('autocomplete')}}"
  },
  method: 'GET',
  dataUrlParams: {'chunk': 1, 't': 'books'},
  allowFreeEntries: false,
  allowDuplicates: false,
  ajaxConfig: {

  complete: function(xhr, status) {
    finished = xhr.responseJSON.finished;
    additionalSuggestions = xhr.responseJSON.results;
    $('#current-query').text(lastQuery);
  },

  beforeSend: function(xhr, options) {
    var queryValue = options.url.match(/query=(\S*)&chunk/);
    if (queryValue === null) {
      xhr.abort();
      console.log('query empty');
    }
    queryValue = queryValue[1].trim();
    if (!(queryValue.length == 0)) {
      if (queryValue.startsWith(lastQuery) && finished) {
        xhr.abort();
        console.log('no more suggestions to load for this query');
      }
      lastQuery = queryValue;
    } else {
      xhr.abort();
      console.log('query empty');
    }
  }

  },
  minChars: 2,
  hideTrigger: true,
  value: {{books_array|tojson}},
  displayField: 'title'
  });


  $('#load-more-suggestions-button').click( function(e) {
    if (finished || lastQuery === null) {
      $(this).addClass('disabled');
      return;
  }

  $(this).removeClass('disabled');
  chunk++;
  $.ajax({
  url: ("{{url_for('autocomplete')}}?t=books&query=" + lastQuery + "&chunk=" + chunk)
}).done(function(data, status, xhr) {
    additionalSuggestions = additionalSuggestions.concat(data.results);
    finished = data.finished;
}).fail(function(xhr, status, error) {
    chunk--;
    console.log('query loading failed with status' + status);
});

  });

  $('form').submit(function(e) {
    var valuesString = ''
    for (var i of suggestionsField.getSelection()) {
      valuesString += i.id + ',';
    }
    valuesString = valuesString.endsWith(',')? valuesString.slice(0, valuesString.lastIndexOf(',')) : valuesString;
    $('#books').val(valuesString);
  });

});

</script>
{% endblock custom_js %}
